{% extends "base.html" %}
{% block content %}
<h2 class="mb-4">玩家一覽表</h2>

<table class="table table-bordered table-hover align-middle text-center">
  <thead>
    <tr>
      <th style="background-color:#FFA500;">鐵衣</th>
      <th style="background-color:#FF0000; color:#fff;">血河</th>
      <th style="background-color:#ADD8E6;">碎夢</th>
      <th style="background-color:#0e536e; color:#fff;">神相</th>
      <th style="background-color:#bd6dbd; color:#fff;">九靈</th>
      <th style="background-color:#f0f02c;">玄機</th>
      <th style="background-color:#FFC0CB;">素問</th>
      <th style="background-color:#34bd34; color:#fff;">龍吟</th>
    </tr>
  </thead>
  <tbody>
    {% set max_len = grouped.values()|map('length')|max %}
    {% for i in range(max_len) %}
    <tr>
      {% for job in jobs %}
        <td>
          {% if grouped[job]|length > i %}
            <div class="d-flex justify-content-between align-items-center">
              <span>{{ grouped[job][i].player_name }}</span>
              <span class="badge {% if grouped[job][i].can_fight %}bg-success{% else %}bg-secondary{% endif %} toggle-status"
                    data-id="{{ grouped[job][i].id }}" data-job="{{ grouped[job][i].job }}">
                {% if grouped[job][i].can_fight %}能打{% else %}請假{% endif %}
              </span>
            </div>
          {% endif %}
        </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>

<h2 class="mt-5">職業統計</h2>
<table class="table table-striped table-hover" id="stats-table">
  <thead class="table-dark">
    <tr>
      <th>職業</th>
      <th>總數</th>
      <th>能打</th>
      <th>請假</th>
    </tr>
  </thead>
  <tbody>
    {% for job, stat in stats.items() %}
    <tr data-job="{{ job }}">
      <td>{{ job }}</td>
      <td class="total">{{ stat.total }}</td>
      <td class="can_fight">{{ stat.can_fight }}</td>
      <td class="leave">{{ stat.leave }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
$(document).ready(function(){
  $(".toggle-status").click(function(){
    var badge = $(this);
    var playerId = badge.data("id");
    var job = badge.data("job");
    $.post("/toggle/" + playerId, function(data){
      if(data.status === "success"){
        if(data.can_fight){
          badge.removeClass("bg-secondary").addClass("bg-success").text("能打");
        } else {
          badge.removeClass("bg-success").addClass("bg-secondary").text("請假");
        }
        var row = $("#stats-table tr[data-job='" + job + "']");
        var can_fight = parseInt(row.find(".can_fight").text());
        var leave = parseInt(row.find(".leave").text());
        if(data.can_fight){
          row.find(".can_fight").text(can_fight + 1);
          row.find(".leave").text(leave - 1);
        } else {
          row.find(".can_fight").text(can_fight - 1);
          row.find(".leave").text(leave + 1);
        }
      }
    });
  });
});
</script>
{% endblock %}