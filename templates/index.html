{% extends "base.html" %}
{% block content %}
<h2 class="mb-4">玩家總覽</h2>

<!-- 大表格：只顯示名字 + 請假切換 -->
<table class="table table-bordered table-hover align-middle text-center">
  <thead>
    <tr>
      {% for job in job_styles.keys() %}
       <th style="background-color:{{ job_styles[job]['bg'] }}; color:{{ job_styles[job]['fg'] }};">
          {{ job }}
        </th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for i in range(max_len) %}
    <tr>
      {% for job in job_styles.keys() %}
        <td>
          {% if grouped[job]|length > i %}
            <div class="d-flex justify-content-between align-items-center">
              <span>{{ grouped[job][i].player_name }}</span>
              <button class="btn btn-sm toggle-btn 
                {% if grouped[job][i].can_fight %}btn-success{% else %}btn-secondary{% endif %}" 
                data-id="{{ grouped[job][i].id }}">
                {% if grouped[job][i].can_fight %}能打{% else %}請假{% endif %}
              </button>
            </div>
          {% endif %}
        </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- 底下職業統計 -->
<h3 class="mt-5">職業統計</h3>
<table class="table table-sm table-bordered text-center align-middle">
  <thead class="table-light">
    <tr>
      <th>職業</th>
      <th>總人數</th>
      <th>能打</th>
      <th>請假</th>
    </tr>
  </thead>
  <tbody>
    {% for job, data in stats.items() %}
    <tr>
      <td>{{ job }}</td>
      <td>{{ data.total }}</td>
      <td>{{ data.can_fight }}</td>
      <td>{{ data.leave }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  $(document).on('click', '.toggle-btn', function() {
    var playerId = $(this).data('id');
    var btn = $(this);
    $.post('/toggle/' + playerId, function(response) {
      if (response.status === "success") {
        if (response.can_fight) {
          btn.removeClass('btn-secondary').addClass('btn-success').text('能打');
        } else {
          btn.removeClass('btn-success').addClass('btn-secondary').text('請假');
        }
      }
    });
  });
</script>
{% endblock %}